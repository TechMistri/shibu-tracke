<!DOCTYPE html>
<html>
  <head>
    <title>Shibu Live Location</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        text-align: center;
        padding: 20px;
        background: #f3f4f6;
        color: #333;
      }
      h1 {
        color: #2c3e50;
      }
      #map {
        width: 100%;
        max-width: 800px;
        height: 50vh;
        margin: 20px auto;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      button {
        background: #10b981;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 15px;
        transition: background-color 0.3s;
      }
      button:hover {
        background: #059669;
      }
      button.stop {
        background: #ef4444;
      }
      button.stop:hover {
        background: #dc2626;
      }
      #status {
        margin-top: 20px;
        font-size: 1.1em;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h1>üìç Shibu Live Location Tracker</h1>
    <div id="content"></div>
    <div id="map" style="display: none;"></div>
    <div id="status"></div>

    <script>
      // 1. SECURITY WARNING: Your Firebase keys are visible here.
      // Ensure you have set up Firebase Security Rules to protect your database!
      // Example rules:
      // {
      //   "rules": {
      //     "liveLocation": {
      //       ".read": "auth.uid === 'YOUR_ADMIN_UID'", // Only admin can read
      //       ".write": "auth != null"  // Any authenticated user can write
      //     }
      //   }
      // }
      const firebaseConfig = {
        apiKey: "AIzaSyA8urfCvruIDR1G1szDu1oSSh2yALUw4DI",
        authDomain: "sbj-education.firebaseapp.com",
        databaseURL: "https://sbj-education-default-rtdb.firebaseio.com",
        projectId: "sbj-education",
        storageBucket: "sbj-education.appspot.com",
        messagingSenderId: "281508002260",
        appId: "1:281508002260:web:38f5f770f37b2fdc87be41",
        measurementId: "G-YHJRSDB6WB",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // --- Common Elements ---
      const contentDiv = document.getElementById("content");
      const mapDiv = document.getElementById("map");
      const statusDiv = document.getElementById("status");

      const mode = new URLSearchParams(window.location.search).get("mode");

      // --- Admin Mode ---
      if (mode === "admin") {
        document.title = "Admin - Live Location";
        contentDiv.innerHTML = `<h2>Live Location View (Admin)</h2>`;
        mapDiv.style.display = 'block';

        let map, marker;
        let initialLoad = true;

        window.initMap = function () {
          // Initialize map centered on a general location
          map = new google.maps.Map(mapDiv, {
            center: { lat: 20.5937, lng: 78.9629 }, // Center of India
            zoom: 5,
          });

          // Create a reusable marker
          marker = new google.maps.Marker({ map, title: "Shibu's Location" });

          // Listen for location updates from Firebase
          db.ref("liveLocation").on("value", (snapshot) => {
            const data = snapshot.val();
            if (data && data.lat && data.lon) {
              const pos = { lat: data.lat, lng: data.lon };
              
              // If marker doesn't have a position yet, set it. Otherwise, animate it.
              if (!marker.getPosition()) {
                  marker.setPosition(pos);
              } else {
                  marker.setPosition(pos); // Or use an animation library for smoother moves
              }
              
              map.setCenter(pos);
              // Zoom in on the first successful data load
              if (initialLoad) {
                  map.setZoom(16);
                  initialLoad = false;
              }
              
              const updateTime = new Date(data.time).toLocaleString();
              statusDiv.textContent = `Last updated: ${updateTime}`;
            } else {
              statusDiv.textContent = 'Waiting for location data...';
            }
          });
        };

      // --- User Mode ---
      } else {
        let watchId = null; // To store the ID of the geolocation watch

        contentDiv.innerHTML = `
          <p>Click the button below to share your live location.</p>
          <button id="startButton">Share My Live Location</button>
          <button id="stopButton" class="stop" style="display:none;">Stop Sharing</button>
        `;

        const startButton = document.getElementById("startButton");
        const stopButton = document.getElementById("stopButton");

        const startSharing = () => {
          if (!navigator.geolocation) {
            statusDiv.textContent = "Geolocation is not supported by your browser.";
            return;
          }

          // IMPROVEMENT 2: Use `watchPosition` for continuous updates
          watchId = navigator.geolocation.watchPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              db.ref("liveLocation").set({
                lat: latitude,
                lon: longitude,
                time: new Date().toISOString(),
              });
              statusDiv.textContent = "‚úÖ Sharing location... Last update sent just now.";
            },
            () => {
              statusDiv.textContent = "‚ùå Unable to fetch location. Please ensure you have granted permission.";
            },
            { // Options for watchPosition
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
          );
          
          // Update UI
          startButton.style.display = 'none';
          stopButton.style.display = 'inline-block';
        };

        const stopSharing = () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId); // Stop watching
                watchId = null;
                statusDiv.textContent = "üõë Location sharing stopped.";

                // Optionally, clear the location from Firebase
                // db.ref("liveLocation").remove();
            }
            // Update UI
            startButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
        };
        
        // IMPROVEMENT 3: Use addEventListener for cleaner code
        startButton.addEventListener('click', startSharing);
        stopButton.addEventListener('click', stopSharing);
        
        // No need to load Google Maps for the user
        window.initMap = function() {};
      }
    </script>

    <!-- 
      2. SECURITY WARNING: Your Google Maps API key is visible here.
      To prevent unauthorized use and charges, restrict this key in your Google Cloud Console.
      Set its "Application restrictions" to "HTTP referrers" and add your website's domain.
    -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCf1TDzzxs2aW0vMzIfbMLFTF_9KcA6c-0&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>